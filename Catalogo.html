<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo, Dirección y Opciones de Pago (Webpay/Transferencia)</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
        }

        header {
            background-color: lightskyblue;
            color: black;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .contenedor {
            display: flex;
            gap: 20px;
            padding: 20px;
        }
        
        .catalogo {
            flex: 3; 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            padding: 0;
        }

        .producto {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .producto:hover {
            transform: scale(1.02);
        }

        .btn {
            background: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background: #45a049;
        }
        
        .stock-cero {
            color: red;
            font-weight: bold;
        }

        .stock-ok {
            color: green;
        }
        
        .carrito {
            flex: 1; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .item-carrito {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
        }

        .controles {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-peq {
            background: #ccc;
            border: none;
            padding: 5px 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .total {
            margin-top: 20px;
            font-weight: bold;
            font-size: 1.3rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }
        
        #modalTransferencia {
            z-index: 2000;
            background: rgba(0, 0, 0, 0.8);
        }

        .modal-contenido {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .cerrar {
            float: right;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.5rem;
            color: #aaa;
        }

        .formulario-direccion label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }

        .formulario-direccion input {
            width: 95%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        
        #modalResumen table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        #modalResumen th,
        #modalResumen td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        #direccionMostrada {
            border: 1px solid #eee;
            padding: 10px;
            margin: 10px 0;
            background: #f9f9f9;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .btn-pago-opcion {
            padding: 12px 15px;
            border: none;
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .btn-webpay {
            background: #0078d4;
            color: white;
        }
        .btn-webpay:hover {
            background: #005fa3;
        }

        .btn-transferencia {
            background: #f7a81b; 
            color: white;
        }
        .btn-transferencia:hover {
            background: #e39600;
        }
        
        #modalTransferencia ul {
            list-style: none;
            padding: 0;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 5px;
            background: #f9f9f9;
        }
        #modalTransferencia ul li {
            margin-bottom: 8px;
        }
        #modalTransferencia strong {
            display: inline-block;
            width: 120px;
        }
        #modalTransferencia input[type="file"] {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <header>
        <h1>Catálogo de Productos</h1>
    </header>

    <div class="contenedor">
        
        <section class="catalogo" id="listaCatalogo">
            
        </section>

        <aside class="carrito">
            <h2>Carrito</h2>
            <ul id="itemsCarrito">
                
            </ul>
            <p class="total">Total: $<span id="total">0</span></p>
            <button id="btnCheckout" class="btn">Continuar al Pago</button>
        </aside>
    </div>

    <div id="modalDireccion" class="modal">
        <div class="modal-contenido formulario-direccion">
            <span class="cerrar" data-modal="direccion">&times;</span>
            <h2>Ingresar Coordenadas de Envío</h2>
            <form id="formDireccion">
                <label for="calleInput">Calle</label>
                <input type="text" id="calleInput" name="calle" placeholder="Ej: Los Pinos" required>

                <label for="numeroInput">Número</label>
                <input type="text" id="numeroInput" name="numero" placeholder="Ej: 1234" required>

                <label for="latInput">Latitud (Ej: -33.4489)</label>
                <input type="number" step="any" id="latInput" name="latInput" placeholder="-33.4489" required>

                <label for="lonInput">Longitud (Ej: -70.6693)</label>
                <input type="number" step="any" id="lonInput" name="lonInput" placeholder="-70.6693" required>

                <button type="submit" class="btn">Confirmar Dirección</button>
            </form>
        </div>
    </div>

    <div id="modalResumen" class="modal">
        <div class="modal-contenido">
            <span class="cerrar" data-modal="resumen">&times;</span>
            <h2>Resumen del Pedido</h2>
            <div id="direccionMostrada"></div> 
            <table>
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cant.</th>
                        <th>Precio Unitario</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody id="tablaResumen"></tbody>
            </table>
            <p class="total">Total a Pagar: $<span id="totalResumen">0</span></p>
            
            <hr style="margin: 20px 0;">
            <p style="font-weight: bold; text-align: center;">Selecciona tu método de pago:</p>
            
            <button id="btnWebpay" class="btn-pago-opcion btn-webpay">Pagar con Webpay (Simulación)</button>
            <button id="btnTransferencia" class="btn-pago-opcion btn-transferencia">Pagar con Transferencia Bancaria</button>
        </div>
    </div>
    
    <div id="modalTransferencia" class="modal">
        <div class="modal-contenido">
            <span class="cerrar" data-modal="transferencia">&times;</span>
            <h3>Datos para Transferencia</h3>
            <ul>
                <li><strong>Banco:</strong> Banco de Chile</li>
                <li><strong>Tipo de Cuenta:</strong> Cuenta Corriente</li>
                <li><strong>Número de Cuenta:</strong> 123456789</li>
                <li><strong>RUT:</strong> 11.111.111-1</li>
                <li><strong>Nombre:</strong> Juan Pérez</li>
                <li><strong>Correo:</strong> pagos@mitienda.cl</li>
            </ul>
            <label for="comprobante"><strong>Adjuntar comprobante:</strong></label>
            <input type="file" id="comprobante" accept=".pdf,.png,.jpg">
            <button class="btn" style="width: 100%; margin-top: 15px;" id="btnConfirmarTransferencia">Hecho (Simular Cierre de Pedido)</button>
        </div>
    </div>

    <script src="api.js"></script>
    <script>
        let carrito = {};
        let productosDisponibles = [];
        let ultimaDireccion = {};
        
        const listaCatalogo = document.getElementById('listaCatalogo');
        const itemsCarrito = document.getElementById('itemsCarrito');
        const totalElemento = document.getElementById('total');
        const btnCheckout = document.getElementById('btnCheckout');
        
        const modalDireccion = document.getElementById('modalDireccion');
        const formDireccion = document.getElementById('formDireccion');
        const calleInput = document.getElementById('calleInput');
        const numeroInput = document.getElementById('numeroInput');
        const latInput = document.getElementById('latInput');
        const lonInput = document.getElementById('lonInput');

        const modalResumen = document.getElementById("modalResumen");
        const tablaResumen = document.getElementById("tablaResumen");
        const totalResumen = document.getElementById("totalResumen");
        const direccionMostrada = document.getElementById("direccionMostrada");
        const btnWebpay = document.getElementById("btnWebpay");
        const btnTransferencia = document.getElementById("btnTransferencia");
        const modalTransferencia = document.getElementById("modalTransferencia");
        const btnConfirmarTransferencia = document.getElementById("btnConfirmarTransferencia");
        const botonesCerrar = document.querySelectorAll(".cerrar");
        
        function verificarAutenticacion() {
            const usuarioId = localStorage.getItem('usuarioId');
            if (!usuarioId) {
                alert('Debes iniciar sesión para acceder al catálogo.');
                window.location.href = 'Inicio sesion.html';
                return false;
            }
            return usuarioId;
        }

        const GET_PRODUCTOS_QUERY = `
            query {
                getProductos {
                    id
                    nombre
                    descripcion
                    precio
                    stock
                }
            }
        `;

        async function cargarProductos() {
            try {
                const data = await graphqlRequest(GET_PRODUCTOS_QUERY);
                productosDisponibles = data.getProductos;
                renderizarProductos();
            } catch (error) {
                alert('Error al cargar productos: ' + error.message);
            }
        }

        function renderizarProductos() {
            let html = '';
            if (productosDisponibles.length === 0) {
                 html = '<p>No hay productos disponibles en este momento.</p>';
            } else {
                productosDisponibles.forEach(p => {
                    html += `
                        <div class="producto">
                            <h4>${p.nombre}</h4>
                            <p>${p.descripcion ? p.descripcion : 'Sin descripción'}</p>
                            <p><strong>$${p.precio.toLocaleString('es-CL')}</strong></p>
                            <p class="${p.stock > 0 ? 'stock-ok' : 'stock-cero'}">
                                Stock: ${p.stock}
                            </p>
                            <button 
                                class="btn btn-agregar" 
                                data-id="${p.id}" 
                                data-nombre="${p.nombre}" 
                                data-precio="${p.precio}"
                                data-stock="${p.stock}"
                                ${p.stock === 0 ? 'disabled' : ''}
                            >
                                Añadir al Carrito
                            </button>
                        </div>
                    `;
                });
            }

            listaCatalogo.innerHTML = html;
            
            document.querySelectorAll('.btn-agregar').forEach(btn => {
                btn.addEventListener('click', agregarACarrito);
            });
        }

        function agregarACarrito(e) {
            const id = e.target.getAttribute('data-id');
            const nombre = e.target.getAttribute('data-nombre');
            const precio = parseFloat(e.target.getAttribute('data-precio'));
            const stock = parseInt(e.target.getAttribute('data-stock'));

            if (carrito[id]) {
                if (carrito[id].cantidad < stock) {
                    carrito[id].cantidad++;
                } else {
                    alert(`No puedes agregar más de ${stock} unidades de ${nombre}.`);
                }
            } else {
                carrito[id] = { id, nombre, precio, stock, cantidad: 1 };
            }

            actualizarCarrito();
        }
        
        function actualizarCarrito() {
            itemsCarrito.innerHTML = '';
            let total = 0;
            
            if (Object.keys(carrito).length === 0) {
                itemsCarrito.innerHTML = '<li style="text-align: center;">El carrito está vacío.</li>';
                btnCheckout.disabled = true;
            } else {
                btnCheckout.disabled = false;
                
                for (const id in carrito) {
                    const item = carrito[id];
                    const subtotal = item.precio * item.cantidad;
                    total += subtotal;

                    const li = document.createElement("li");
                    li.classList.add("item-carrito");
                    li.innerHTML = `
                        <span>${item.nombre} (x${item.cantidad})</span>
                        <div class="controles">
                            <button class="btn-peq restar" data-id="${id}">-</button>
                            <button class="btn-peq sumar" data-id="${id}">+</button>
                            <button class="btn-peq eliminar" data-id="${id}">X</button>
                        </div>
                    `;
                    itemsCarrito.appendChild(li);
                }

                document.querySelectorAll('.sumar').forEach(btn => btn.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    const item = carrito[id];
                    if (item.cantidad < item.stock) item.cantidad++;
                    actualizarCarrito();
                }));
                document.querySelectorAll('.restar').forEach(btn => btn.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    carrito[id].cantidad--;
                    if (carrito[id].cantidad <= 0) delete carrito[id];
                    actualizarCarrito();
                }));
                document.querySelectorAll('.eliminar').forEach(btn => btn.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    delete carrito[id];
                    actualizarCarrito();
                }));
            }

            totalElemento.textContent = total.toLocaleString('es-CL');
        }

        const CREAR_PEDIDO_MUTATION = `
            mutation CrearPedido($clienteId: ID!, $items: [ItemPedidoInput!]!, $direccion: DireccionInput!) {
                crearPedido(clienteId: $clienteId, items: $items, direccion: $direccion) {
                    id
                    total
                    estado
                }
            }
        `;

        formDireccion.addEventListener('submit', async function(e) {
            e.preventDefault();

            const usuarioId = verificarAutenticacion();
            if (!usuarioId) return;

            const direccion = {
                calle: calleInput.value.trim(),
                numero: numeroInput.value.trim(),
                lat: parseFloat(latInput.value),
                lon: parseFloat(lonInput.value)
            };
            
            if (isNaN(direccion.lat) || isNaN(direccion.lon)) {
                 alert('Por favor, ingrese Latitud y Longitud válidas.');
                 return;
            }

            const itemsInput = Object.values(carrito).map(item => ({
                productoId: item.id,
                cantidad: item.cantidad
            }));

            try {
                const variables = {
                    clienteId: usuarioId,
                    items: itemsInput,
                    direccion: direccion
                };

                const data = await graphqlRequest(CREAR_PEDIDO_MUTATION, variables);
                
                alert(`Pedido N°${data.crearPedido.id.slice(-6)} creado con éxito! Estado: ${data.crearPedido.estado}. Total: $${data.crearPedido.total.toLocaleString('es-CL')}`);
                
                carrito = {};
                actualizarCarrito();
                modalDireccion.style.display = 'none';
                modalResumen.style.display = 'none';
                modalTransferencia.style.display = 'none';
                cargarProductos();

            } catch (error) {
                alert('Error al procesar el pedido: ' + error.message);
            }
        });

        function mostrarResumen() {
            tablaResumen.innerHTML = "";
            let total = 0;
            const calle = calleInput.value;
            const numero = numeroInput.value;

            for (let id in carrito) {
                const item = carrito[id];
                const subtotal = item.precio * item.cantidad;
                total += subtotal;

                const fila = document.createElement("tr");
                fila.innerHTML = `
                    <td>${item.nombre}</td>
                    <td>${item.cantidad}</td>
                    <td>$${item.precio.toLocaleString('es-CL')}</td>
                    <td>$${subtotal.toLocaleString('es-CL')}</td>
                `;
                tablaResumen.appendChild(fila);
            }

            totalResumen.textContent = total.toLocaleString('es-CL');
            direccionMostrada.textContent = `Dirección: ${calle} ${numero}. Coordenadas: ${latInput.value}, ${lonInput.value}`; 
            modalResumen.style.display = "flex";
        }

        btnCheckout.addEventListener("click", () => {
            if (Object.keys(carrito).length === 0) return;
            modalDireccion.style.display = "flex";
        });
        
        btnWebpay.addEventListener("click", () => {
            alert("Redirigiendo a pasarela Webpay... (Simulación de pago exitoso)");
            formDireccion.dispatchEvent(new Event('submit'));
        });

        btnTransferencia.addEventListener("click", () => {
            modalResumen.style.display = "none";
            modalTransferencia.style.display = "flex";
        });

        btnConfirmarTransferencia.addEventListener("click", () => {
            alert("Comprobante adjuntado y Transferencia notificada. Su pedido será procesado al confirmar el pago. (Simulación)");
            formDireccion.dispatchEvent(new Event('submit'));
        });

        botonesCerrar.forEach(boton => {
            boton.addEventListener("click", () => {
                const modalAttr = boton.getAttribute("data-modal");
                if (modalAttr === "direccion") modalDireccion.style.display = "none";
                if (modalAttr === "resumen") modalResumen.style.display = "none";
                if (modalAttr === "transferencia") modalTransferencia.style.display = "none";
            });
        });

        window.addEventListener("click", e => {
            if (e.target === modalDireccion) modalDireccion.style.display = "none";
            if (e.target === modalResumen) modalResumen.style.display = "none";
            if (e.target === modalTransferencia) modalTransferencia.style.display = "none";
        });
        
        verificarAutenticacion();
        cargarProductos();
        actualizarCarrito();
    </script>
</body>
</html>